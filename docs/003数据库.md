# 朴分系统数据库设计（SQLite）- 表结构表格版

## 1. 用户表（`users`）

| 字段名            | 数据类型 | 主键/外键 | 约束                    | 默认值            | 说明                                   |
| ----------------- | -------- | --------- | ----------------------- | ----------------- | -------------------------------------- |
| `id`              | INTEGER  | 主键      | AUTOINCREMENT, NOT NULL | -                 | 用户唯一标识                           |
| `username`        | TEXT     | -         | NOT NULL, UNIQUE        | -                 | 用户名（登录用，需唯一）               |
| `password`        | TEXT     | -         | NOT NULL                | -                 | 密码                                   |
| `total_points`    | INTEGER  | -         | NOT NULL                | 0                 | 用户当前总朴分                         |
| `status`          | TINYINT  | -         | NOT NULL                | 1                 | 账号状态（1=正常，0=注销）             |
| `last_login_time` | DATETIME | -         | NULL                    | -                 | 最后登录时间                           |
| `created_at`      | DATETIME | -         | NOT NULL                | CURRENT_TIMESTAMP | 账号创建时间                           |
| `updated_at`      | DATETIME | -         | NOT NULL                | CURRENT_TIMESTAMP | 账号信息更新时间                       |
| **索引**          |          |           |                         |                   | `idx_users_username`（用户名查询优化） |

## 2. 签到周期表（`checkin_cycles`）

| 字段名       | 数据类型 | 主键/外键 | 约束                    | 默认值            | 说明                       |
| ------------ | -------- | --------- | ----------------------- | ----------------- | -------------------------- |
| `id`         | INTEGER  | 主键      | AUTOINCREMENT, NOT NULL | -                 | 周期唯一标识               |
| `start_date` | DATE     | -         | NOT NULL                | -                 | 周期开始日期（固定为周一） |
| `end_date`   | DATE     | -         | NOT NULL                | -                 | 周期结束日期（固定为周日） |
| `config`     | JSON     | -         | NOT NULL                | -                 | 一周签到配置的 JSON 数据   |
| `created_at` | DATETIME | -         | NOT NULL                | CURRENT_TIMESTAMP | 周期创建时间               |
| `updated_at` | DATETIME | -         | NOT NULL                | CURRENT_TIMESTAMP | 周期信息更新时间           |

**约束**：

- `CHECK (start_date < end_date)`：确保周期的开始日期早于结束日期。

**索引**：

- `idx_checkin_cycles_date`：在 `start_date` 和 `end_date` 上创建索引，用于按日期范围查询周期。

**说明**：

- 将签到配置表的数据存储为 JSON 格式，直接嵌入到签到周期表中。
- 每条记录表示一个签到周期，`config` 字段包含该周期内每天的签到配置。
- 删除了原来的签到配置表（`checkin_configs`）。

**JSON 数据示例**：

```json
[
  {
    "day_of_week": 1,
    "points": 10,
    "is_surprise": 0,
    "surprise_info": null
  },
  {
    "day_of_week": 2,
    "points": 15,
    "is_surprise": 1,
    "surprise_info": {
      "type": "coupon",
      "value": "10元优惠券"
    }
  },
  {
    "day_of_week": 3,
    "points": 20,
    "is_surprise": 0,
    "surprise_info": null
  }
]
```

## 3 用户-签到关联记录表（`user_checkin_configs`）

| 字段名       | 数据类型 | 主键/外键 | 约束                         | 默认值            | 说明                                                                                    |
| ------------ | -------- | --------- | ---------------------------- | ----------------- | --------------------------------------------------------------------------------------- |
| `id`         | INTEGER  | 主键      | AUTOINCREMENT, NOT NULL      | -                 | 用户签到配置记录唯一标识                                                                |
| `user_id`    | INTEGER  | 外键      | NOT NULL                     | -                 | 关联用户表（`users.id`），级联删除                                                      |
| `cycle_id`   | INTEGER  | 外键      | NOT NULL                     | -                 | 关联签到周期表（`checkin_cycles.id`），级联删除                                         |
| `end_time`   | DATE     | -         | NOT NULL                     | -                 | 签到表结束时间                                                                          |
| `day1`       | TINYINT  | -         | NOT NULL                     | 0                 | day1 是否签到                                                                           |
| `day2`       | TINYINT  | -         | NOT NULL                     | 0                 | day2 是否签到                                                                           |
| `day3`       | TINYINT  | -         | NOT NULL                     | 0                 | day3 是否签到                                                                           |
| `day4`       | TINYINT  | -         | NOT NULL                     | 0                 | day4 是否签到                                                                           |
| `day5`       | TINYINT  | -         | NOT NULL                     | 0                 | day5 是否签到                                                                           |
| `day6`       | TINYINT  | -         | NOT NULL                     | 0                 | day6 是否签到                                                                           |
| `day7`       | TINYINT  | -         | NOT NULL                     | 0                 | day7 是否签到                                                                           |
| `created_at` | DATETIME | -         | NOT NULL                     | CURRENT_TIMESTAMP | 记录创建时间                                                                            |
| `updated_at` | DATETIME | -         | NOT NULL                     | CURRENT_TIMESTAMP | 记录更新时间                                                                            |
| **约束**     |          |           | `UNIQUE (user_id, cycle_id)` |                   | 确保用户每个周期仅匹配一个签到配置                                                      |
| **索引**     |          |           |                              |                   | `idx_user_checkin_configs__user_endtime`（按用户 user_id 和结束时间 end_time 查询优化） |

## 4. 组队表（`teams`）

| 字段名           | 数据类型 | 主键/外键 | 约束                                 | 默认值            | 说明                                                           |
| ---------------- | -------- | --------- | ------------------------------------ | ----------------- | -------------------------------------------------------------- |
| `id`             | INTEGER  | 主键      | AUTOINCREMENT, NOT NULL              | -                 | 组队唯一标识                                                   |
| `team_code`      | TEXT     | -         | NOT NULL, UNIQUE                     | -                 | 8 位数字组队码（用于队员加入，唯一）                           |
| `captain_id`     | INTEGER  | 外键      | NOT NULL                             | -                 | 关联用户表（`users.id`，队长 ID），级联删除                    |
| `status`         | TEXT     | -         | NOT NULL                             | 'pending'         | 组队状态（`pending`=进行中，`completed`=成功，`expired`=过期） |
| `created_time`   | DATETIME | -         | NOT NULL                             | CURRENT_TIMESTAMP | 组队创建时间                                                   |
| `expire_time`    | DATETIME | -         | NOT NULL                             | -                 | 组队过期时间（最长 4 小时，不超过当日 24:00）                  |
| `completed_time` | DATETIME | -         | NULL                                 | -                 | 组队成功完成时间（满 4 人时更新）                              |
| `created_at`     | DATETIME | -         | NOT NULL                             | CURRENT_TIMESTAMP | 记录创建时间                                                   |
| `updated_at`     | DATETIME | -         | NOT NULL                             | CURRENT_TIMESTAMP | 记录更新时间                                                   |
| **约束**         |          |           | `CHECK (expire_time > created_time)` |                   | 确保过期时间晚于创建时间                                       |
| **索引**         |          |           |                                      |                   | `idx_teams_code`（按组队码查询优化）                           |
| **索引**         |          |           |                                      |                   | `idx_teams_status_time`（按状态+时间查询优化，如清理过期组队） |

## 5. 组队成员表（`team_members`）

| 字段名       | 数据类型 | 主键/外键 | 约束                        | 默认值            | 说明                                                |
| ------------ | -------- | --------- | --------------------------- | ----------------- | --------------------------------------------------- |
| `id`         | INTEGER  | 主键      | AUTOINCREMENT, NOT NULL     | -                 | 成员记录唯一标识                                    |
| `team_id`    | INTEGER  | 外键      | NOT NULL                    | -                 | 关联组队表（`teams.id`），级联删除                  |
| `user_id`    | INTEGER  | 外键      | NOT NULL                    | -                 | 关联用户表（`users.id`），级联删除                  |
| `role`       | TEXT     | -         | NOT NULL                    | -                 | 成员角色（`captain`=队长，`member`=队员）           |
| `join_time`  | DATETIME | -         | NOT NULL                    | CURRENT_TIMESTAMP | 加入组队时间                                        |
| `created_at` | DATETIME | -         | NOT NULL                    | CURRENT_TIMESTAMP | 记录创建时间                                        |
| `updated_at` | DATETIME | -         | NOT NULL                    | CURRENT_TIMESTAMP | 记录更新时间                                        |
| **约束**     |          |           | `UNIQUE (team_id, user_id)` |                   | 确保用户同一组队内仅加入一次                        |
| **索引**     |          |           |                             |                   | `idx_team_members_team`（按组队查询成员优化）       |
| **索引**     |          |           |                             |                   | `idx_team_members_user`（按用户查询参与的组队优化） |

## 6. 商品券表（`products`）

| 字段名        | 数据类型 | 主键/外键 | 约束                    | 默认值            | 说明                                            |
| ------------- | -------- | --------- | ----------------------- | ----------------- | ----------------------------------------------- |
| `id`          | INTEGER  | 主键      | AUTOINCREMENT, NOT NULL | -                 | 商品唯一标识                                    |
| `name`        | TEXT     | -         | NOT NULL                | -                 | 商品名称（如“10 元优惠券”）                     |
| `description` | TEXT     | -         | NULL                    | -                 | 商品描述（使用规则、有效期等）                  |
| `points`      | INTEGER  | -         | NOT NULL                | -                 | 兑换所需朴分                                    |
| `image_url`   | TEXT     | -         | NULL                    | -                 | 商品券图片 URL（前端展示用）                    |
| `status`      | TINYINT  | -         | NOT NULL                | 1                 | 商品券状态（2=用于生成签到,1=可兑换，0=已下架） |
| `created_at`  | DATETIME | -         | NOT NULL                | CURRENT_TIMESTAMP | 商品券创建时间                                  |
| `updated_at`  | DATETIME | -         | NOT NULL                | CURRENT_TIMESTAMP | 商品券信息更新时间                              |
| **约束**      |          |           | `CHECK (points > 0)`    |                   | 确保兑换需消耗正朴分                            |
| **索引**      |          |           |                         |                   | `idx_products_status`（查询可兑换商品券优化）   |

## 7. 兑换记录表（`products_exchanges`）

| 字段名          | 数据类型 | 主键/外键 | 约束                    | 默认值            | 说明                                                            |
| --------------- | -------- | --------- | ----------------------- | ----------------- | --------------------------------------------------------------- |
| `id`            | INTEGER  | 主键      | AUTOINCREMENT, NOT NULL | -                 | 兑换记录唯一标识                                                |
| `user_id`       | INTEGER  | 外键      | NOT NULL                | -                 | 关联用户表（`users.id`），级联删除                              |
| `product_id`    | INTEGER  | 外键      | NOT NULL                | -                 | 关联商品表（`products.id`），限制删除（商品下架不删除记录）     |
| `exchange_time` | DATETIME | -         | NOT NULL                | CURRENT_TIMESTAMP | 兑换时间                                                        |
| `points`        | INTEGER  | -         | NOT NULL                | -                 | 兑换消耗的朴分（与`products.points`一致）                       |
| `status`        | TEXT     | -         | NOT NULL                | 'exchanged'       | 兑换状态（`exchanged`=已兑换，`used`=已使用，`expired`=已过期） |
| `expire_at`     | DATE     | -         | NULL                    | -                 | 商品券过期时间，`NULL` 表示永久有效                             |
| `created_at`    | DATETIME | -         | NOT NULL                | CURRENT_TIMESTAMP | 记录创建时间                                                    |
| `updated_at`    | DATETIME | -         | NOT NULL                | CURRENT_TIMESTAMP | 记录更新时间（如状态变更）                                      |
| **约束**        |          |           | `CHECK (points > 0)`    |                   | 确保消耗正朴分                                                  |
| **索引**        |          |           |                         |                   | `idx_exchanges_user`（按用户查询兑换记录优化）                  |
| **索引**        |          |           |                         |                   | `idx_exchanges_time`（按时间范围查询优化）                      |

## 8. 朴分记录表（`point_records`）

| 字段名         | 数据类型 | 主键/外键 | 约束                        | 默认值            | 说明                                                                    |
| -------------- | -------- | --------- | --------------------------- | ----------------- | ----------------------------------------------------------------------- |
| `id`           | INTEGER  | 主键      | AUTOINCREMENT, NOT NULL     | -                 | 朴分记录唯一标识                                                        |
| `user_id`      | INTEGER  | 外键      | NOT NULL                    | -                 | 关联用户表（`users.id`），级联删除                                      |
| `change_type`  | TEXT     | -         | NOT NULL                    | -                 | 变动类型（`checkin`=签到，`team`=组队，`exchange`=兑换，`expire`=过期） |
| `related_info` | TEXT     | -         | NULL                        | -                 | 签到、朴分瓜分、商城兑换、过期                                          |
| `points`       | INTEGER  | -         | NOT NULL                    | -                 | 变动朴分（正数=增加，负数=减少）                                        |
| `total_points` | INTEGER  | -         | NOT NULL                    | -                 | 变动后总朴分（确保非负）                                                |
| `created_time` | DATETIME | -         | NOT NULL                    | CURRENT_TIMESTAMP | 变动时间                                                                |
| `created_at`   | DATETIME | -         | NOT NULL                    | CURRENT_TIMESTAMP | 记录创建时间                                                            |
| `updated_at`   | DATETIME | -         | NOT NULL                    | CURRENT_TIMESTAMP | 记录更新时间                                                            |
| **约束**       |          |           | `CHECK (total_points >= 0)` |                   | 确保总朴分非负                                                          |
| **索引**       |          |           |                             |                   | `idx_point_records_user`（按用户查询朴分记录优化）                      |
| **索引**       |          |           |                             |                   | `idx_point_records_type`（按变动类型筛选优化）                          |

# 朴分系统数据库设计（SQLite）- sql 语言版

# 触发器设置

## 自动更新`updated_at`时间戳

## 用户总朴分自动更新

## 组队状态自动更新
