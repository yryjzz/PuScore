# PuScore 朴分系统 - 已完成功能与 API 接口文档

**项目版本**: v1.7.0  
**更新时间**: 2025 年 9 月 30 日  
**开发状态**: 进行中 - 用户组队记录功能已完成 🆕

## 📋 项目概览

PuScore 朴分系统是一个用户积分管理系统，提供签到获得积分、积分兑换商品券、组队功能等核心业务。系统采用前后端分离架构，后端基于 Node.js + Fastify + SQLite + Sequelize 构建。

### 技术栈

- **后端框架**: Fastify v5.6.1
- **数据库**: SQLite 3 + Se### 2. 管理员接口 (/api/admin/\*) - 仅开发环境

| 接口路径                        | 方法   | 功能描述         | 状态      |
| ------------------------------- | ------ | ---------------- | --------- |
| `/api/admin/time`               | POST   | 设置系统时间     | ✅ 已完成 |
| `/api/admin/time`               | GET    | 获取时间状态     | ✅ 已完成 |
| `/api/admin/time`               | DELETE | 重置系统时间     | ✅ 已完成 |
| `/api/admin/stats`              | GET    | 系统统计信息     | ✅ 已完成 |
| `/api/admin/info`               | GET    | 开发环境信息     | ✅ 已完成 |
| `/api/admin/checkin/generate`   | POST   | 手动生成签到配置 | ✅ 已完成 |
| `/api/admin/checkin/cycles`     | GET    | 查询签到周期列表 | ✅ 已完成 |
| `/api/admin/checkin/current`    | GET    | 查询当前周配置   | ✅ 已完成 |
| `/api/admin/checkin/cycles/:id` | GET    | 查看配置详情     | ✅ 已完成 |
| `/api/admin/checkin/products`   | GET    | 查看商品券列表   | ✅ 已完成 |
| `/api/admin/point/expire`       | POST   | 手动执行朴分过期 | ✅ 已完成 |
| `/api/admin/point/expire-check` | GET    | 检查过期日期     | ✅ 已完成 |

### 3. 朴分相关接口 (/api/point/\*)

| 接口路径             | 方法 | 功能描述     | 认证需求      | 状态      |
| -------------------- | ---- | ------------ | ------------- | --------- |
| `/api/point/checkin` | POST | 用户签到     | ✅ 需要 Token | ✅ 已完成 |
| `/api/point/records` | GET  | 获取朴分记录 | ✅ 需要 Token | ✅ 已完成 |

### 4. 商品兑换接口 (/api/product/\*)

| 接口路径                    | 方法 | 功能描述         | 认证需求      | 状态      |
| --------------------------- | ---- | ---------------- | ------------- | --------- |
| `/api/product/exchangeable` | GET  | 获取可兑换商品券 | ✅ 需要 Token | ✅ 已完成 |
| `/api/product/exchange`     | POST | 兑换商品券       | ✅ 需要 Token | ✅ 已完成 |
| `/api/product/exchanges`    | GET  | 获取兑换记录     | ✅ 需要 Token | ✅ 已完成 |

### 5. 组队功能接口 (/api/team/\*)

| 接口路径                             | 方法 | 功能描述               | 认证需求      | 状态      |
| ------------------------------------ | ---- | ---------------------- | ------------- | --------- |
| `/api/team/check-created-today`      | GET  | 检查今日是否已创建组队 | ✅ 需要 Token | ✅ 已完成 |
| `/api/team/check-joined-today`       | GET  | 检查今日是否已参与组队 | ✅ 需要 Token | ✅ 已完成 |
| `/api/team/:team_code/check-expired` | GET  | 检查组队过期状态       | ❌ 不需要     | ✅ 已完成 |
| `/api/team/create`                   | POST | 队长创建组队           | ✅ 需要 Token | ✅ 已完成 |
| `/api/team/join`                     | POST | 队员加入组队           | ✅ 需要 Token | ✅ 已完成 |
| `/api/team/records`                  | GET  | 获取用户组队记录       | ✅ 需要 Token | ✅ 已完成 |
| `/api/team/:team_code`               | GET  | 获取组队详情           | ❌ 不需要     | ✅ 已完成 |

**🎉 团队奖励功能特点**：

- 混合字符团队码：8 位混合字符（数字+大小写字母）
- 自动奖励分发：团队达到 4 人时自动触发
- 奖励规则：队长获得 70 朴分，队员各获得 10 朴分
- 完整记录：所有奖励变动记录在朴分记录表中

### 6. 系统接口

| 接口路径      | 方法 | 功能描述 | 状态      |
| ------------- | ---- | -------- | --------- |
| `/api/health` | GET  | 健康检查 | ✅ 已完成 |

- **定时任务**: node-cron
- **密码加密**: bcrypt
- **开发工具**: nodemon, dotenv

## 🎯 已完成功能

### ✅ 1. 用户认证功能 (已完成)

- [x] 用户注册 - 用户名唯一性验证，密码确认
- [x] 用户登录 - JWT Token 生成，用户状态验证
- [x] 用户登出 - Token 失效处理
- [x] 修改密码 - 旧密码验证，新密码设置
- [x] 注销账号 - 软删除，状态标记
- [x] 获取个人信息 - 用户资料、朴分余额查询

### ✅ 2. 时间控制系统 (已完成)

- [x] 系统时间设置 - 支持时间戳、日期字符串、时间快进
- [x] 时间状态查询 - 获取当前系统时间状态
- [x] 时间重置 - 恢复真实时间
- [x] 时间统计 - 系统运行时间、内存使用等

### ✅ 3. 签到周期生成系统 (已完成)

- [x] 商品券模型 - 支持可兑换、签到专用、已下架状态
- [x] 签到周期表 - 每周一自动生成 5 个不同签到配置
- [x] 签到配置生成 - 随机朴分(5-25)、随机惊喜(1-3 天)
- [x] 惊喜奖励系统 - 支持商品券和概率瓜分两种类型
- [x] 定时任务 - 每周一 00:00 自动生成新周期
- [x] 手动生成接口 - 管理员可手动生成指定周期

### ✅ 4. 数据库模型 (已完成)

- [x] 用户表 (users) - 用户基本信息、朴分余额
- [x] 商品券表 (products) - 商品信息、兑换朴分、状态管理
- [x] 签到周期表 (checkin_cycles) - 周期时间、JSON 配置存储
- [x] 用户-签到关联表 (user_checkin_configs) - 用户签到配置分配与状态跟踪
- [x] 数据库初始化 - 自动创建表结构、初始数据填充
- [x] 外键约束 - 数据完整性保障
- [x] 索引优化 - 查询性能提升

### ✅ 5. 用户签到信息系统 (已完成)

- [x] 签到配置分配 - 用户首次获取签到信息时自动随机分配当前周配置
- [x] 签到状态跟踪 - 记录用户每天的签到状态(day1-day7)
- [x] 签到信息 API - 获取用户完整签到信息，包含配置和状态
- [x] 今天标记 - 自动识别并标记当前是周几
- [x] 时间兼容 - 支持时间控制服务的调控时间

### ✅ 6. 用户签到执行功能 (已完成)

- [x] 朴分记录表模型 - 创建`point_records`表，支持各类朴分变动记录
- [x] 朴分服务实现 - 完整的签到业务逻辑和朴分管理
- [x] 签到执行接口 - `POST /api/point/checkin` 完整签到流程
- [x] 朴分记录查询 - `GET /api/point/records` 支持分页和筛选
- [x] 重复签到防护 - 检查当日签到状态，防止重复操作
- [x] 惊喜奖励处理 - 支持商品券和概率瓜分两种惊喜奖励
- [x] 事务安全保障 - 使用数据库事务确保数据一致性
- [x] 签到状态同步 - 实时更新用户签到状态到关联表
- [x] 完整测试验证 - 提供完整的 API 测试脚本和验证流程

### ✅ 7. 朴分过期管理功能 (已完成) 🆕

- [x] 朴分过期业务逻辑 - 每年 3.31、6.30、9.30、12.31 日执行朴分清零
- [x] 手动过期 API 接口 - `POST /api/admin/point/expire` 管理员手动触发过期
- [x] 过期日期检查接口 - `GET /api/admin/point/expire-check` 检查当前是否为过期日
- [x] 自动定时任务 - 每年 4 个过期日的 23:59 分自动执行朴分过期
- [x] 过期记录生成 - 在朴分记录表中创建过期类型记录
- [x] 事务安全保障 - 使用数据库事务确保过期操作的数据一致性
- [x] 完整测试验证 - 提供完整的朴分过期功能测试脚本

### ✅ 8. 商品兑换功能 (已完成) 🆕

- [x] 兑换记录表模型 - 创建`products_exchanges`表，支持兑换记录管理
- [x] 商品服务实现 - 完整的商品兑换业务逻辑和数据管理
- [x] 可兑换商品券 API - `GET /api/product/exchangeable` 获取商品券列表和可兑换状态
- [x] 商品兑换接口 - `POST /api/product/exchange` 完整兑换流程
- [x] 兑换记录查询 - `GET /api/product/exchanges` 支持分页和状态筛选
- [x] 过期时间管理 - 支持自定义有效期（默认 2 天）
- [x] 商品券过期检查功能 - 自动定时检查和手动管理员检查
- [x] 事务安全保障 - 使用数据库事务确保数据一致性
- [x] 三表同步更新 - 用户朴分、朴分记录、兑换记录同步处理
- [x] 完整测试验证 - 提供完整的商品兑换功能测试脚本

### ✅ 9. 组队功能 (已完成) 🆕

- [x] 组队数据模型 - 创建`teams`和`team_members`表，支持完整组队管理
- [x] 组队服务实现 - 完整的组队业务逻辑和状态管理
- [x] 队长创建组队 API - `POST /api/team/create` 8 位混合字符组队码生成
- [x] 队员加入组队 API - `POST /api/team/join` 通过组队码加入组队
- [x] 组队状态检查 API - 检查用户每日创建/参与组队限制
- [x] 组队过期管理 - 自动过期状态更新，4 小时或当天结束时间
- [x] 组队详情查询 - `GET /api/team/:team_code` 获取完整组队信息
- [x] 用户组队记录查询 - `GET /api/team/records` 支持分页、角色筛选、状态筛选、时间筛选
- [x] 每日限制检查 - 用户每日只能创建一次组队或参与一次组队
- [x] 时间管理 - 使用本机时间进行过期时间计算和状态检查
- [x] 事务安全保障 - 使用数据库事务确保组队操作的原子性
- [x] 完整测试验证 - 提供完整的组队功能测试脚本

### ✅ 10. 团队奖励分发功能 (已完成) 🎉

- [x] 混合字符团队码 - 8 位混合字符码（数字+大小写字母），保证包含每种类型
- [x] 团队满员检测 - 自动检测团队达到 4 人时触发奖励分发
- [x] 朴分奖励分发 - 队长获得 70 朴分，每个队员获得 10 朴分
- [x] 奖励记录管理 - 使用 pointUtil 创建详细的朴分变动记录
- [x] 事务安全保障 - 确保奖励分发的原子性和数据一致性
- [x] API 响应增强 - 加入奖励分发信息到 API 响应中
- [x] 路由验证更新 - 支持混合字符团队码的正则表达式验证
- [x] 完整测试验证 - 提供完整的团队奖励功能测试脚本

## 🌐 API 接口清单

### 基础信息

- **服务地址**: http://localhost:3000
- **API 前缀**: /api
- **认证方式**: Bearer Token (JWT)

### 统一响应格式

```json
{
  "code": 200, // 状态码：200成功，其他为错误
  "message": "success", // 消息描述
  "data": {} // 业务数据
}
```

## 📡 已实现 API 接口

### 1. 用户认证接口 (/api/auth/\*)

| 接口路径                 | 方法   | 功能描述                           | 认证需求      | 状态      |
| ------------------------ | ------ | ---------------------------------- | ------------- | --------- |
| `/api/auth/register`     | POST   | 用户注册                           | ❌ 不需要     | ✅ 已完成 |
| `/api/auth/login`        | POST   | 用户登录                           | ❌ 不需要     | ✅ 已完成 |
| `/api/auth/logout`       | POST   | 用户登出                           | ✅ 需要 Token | ✅ 已完成 |
| `/api/auth/changepwd`    | POST   | 修改密码                           | ✅ 需要 Token | ✅ 已完成 |
| `/api/auth/delete`       | DELETE | 注销账号                           | ✅ 需要 Token | ✅ 已完成 |
| `/api/auth/user/profile` | GET    | 获取个人信息                       | ✅ 需要 Token | ✅ 已完成 |
| `/api/auth/user/checkin` | GET    | 获取签到信息(用户对应签到表的信息) | ✅ 需要 Token | ✅ 已完成 |

#### 1.1 用户注册 POST `/api/auth/register`

```javascript
// 请求体
{
  "username": "testuser",      // string, 3-20字符，必填
  "password": "123456",        // string, 最少6字符，必填
  "confirmPassword": "123456"  // string, 必须与password一致，必填
}

// 响应体
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "userId": 1,
    "username": "testuser",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 1.2 用户登录 POST `/api/auth/login`

```javascript
// 请求体
{
  "username": "testuser",  // string, 必填
  "password": "123456"     // string, 必填
}

// 响应体
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": 1,
    "username": "testuser",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "totalPoints": 0
  }
}
```

#### 1.3 用户登出 POST `/api/auth/logout`

```javascript
// 请求头
Authorization: Bearer <
  token >
  // 响应体
  {
    code: 200,
    message: "登出成功",
    data: {
      success: true,
    },
  };
```

#### 1.4 修改密码 POST `/api/auth/changepwd`

```javascript
// 请求头
Authorization: Bearer <token>

// 请求体
{
  "oldPassword": "123456",        // string, 必填
  "newPassword": "newpass123",    // string, 最少6字符，必填
  "confirmPassword": "newpass123" // string, 必须与newPassword一致，必填
}

// 响应体
{
  "code": 200,
  "message": "密码修改成功",
  "data": {
    "success": true
  }
}
```

#### 1.5 注销账号 DELETE `/api/auth/delete`

```javascript
// 请求头
Authorization: Bearer <
  token >
  // 响应体
  {
    code: 200,
    message: "账号注销成功",
    data: {
      success: true,
    },
  };
```

#### 1.6 获取个人信息 GET `/api/auth/user/profile`

```javascript
// 请求头
Authorization: Bearer <
  token >
  // 响应体
  {
    code: 200,
    message: "获取成功",
    data: {
      userId: 1,
      username: "testuser",
      totalPoints: 150,
      status: 1,
      lastLoginTime: "2025-09-25T06:40:28.651Z",
      createdAt: "2025-09-25T06:40:28.651Z",
    },
  };
```

#### 1.7 获取签到信息 GET `/api/auth/user/checkin`

```javascript
// 请求头
Authorization: Bearer <
  token >
  // 响应体
  {
    code: 200,
    message: "获取签到信息成功",
    data: {
      user_id: 1,
      cycle_id: 3,
      current_day_of_week: 4,
      week_range: {
        start_date: "2025-09-22",
        end_date: "2025-09-28",
      },
      checkin_data: [
        {
          day_of_week: 1,
          points: 15,
          is_surprise: 0,
          surprise_info: null,
          is_checked_in: 0,
          is_today: false,
        },
        {
          day_of_week: 4,
          points: 20,
          is_surprise: 1,
          surprise_info: {
            type: "coupon",
            coupon_id: 7,
            coupon_name: "签到专享15元券",
            coupon_description: "签到惊喜专享，满80元可用，有效期7天",
          },
          is_checked_in: 0,
          is_today: true, // 今天是周四
        },
        // ... 其余天数 (day 1-7)
      ],
    },
  };
```

### 2. 管理员接口 (/api/admin/\*) - 仅开发环境

| 接口路径                        | 方法   | 功能描述         | 状态      |
| ------------------------------- | ------ | ---------------- | --------- |
| `/api/admin/time`               | POST   | 设置系统时间     | ✅ 已完成 |
| `/api/admin/time`               | GET    | 获取时间状态     | ✅ 已完成 |
| `/api/admin/time`               | DELETE | 重置系统时间     | ✅ 已完成 |
| `/api/admin/stats`              | GET    | 系统统计信息     | ✅ 已完成 |
| `/api/admin/info`               | GET    | 开发环境信息     | ✅ 已完成 |
| `/api/admin/checkin/generate`   | POST   | 手动生成签到配置 | ✅ 已完成 |
| `/api/admin/checkin/cycles`     | GET    | 查询签到周期列表 | ✅ 已完成 |
| `/api/admin/checkin/current`    | GET    | 查询当前周配置   | ✅ 已完成 |
| `/api/admin/checkin/cycles/:id` | GET    | 查看配置详情     | ✅ 已完成 |
| `/api/admin/checkin/products`   | GET    | 查看商品券列表   | ✅ 已完成 |

#### 2.1 设置系统时间 POST `/api/admin/time`

```javascript
// 请求体 (三种方式任选一种)
{
  "timestamp": 1727251200000,           // 时间戳
  "dateString": "2025-09-25 10:00:00", // 日期字符串
  "fastForwardHours": 24                // 快进小时数
}

// 响应体
{
  "code": 200,
  "message": "系统时间设置成功",
  "data": {
    "success": true,
    "currentTime": "2025-09-25T02:00:00.000Z",
    "isTimeControlEnabled": true
  }
}
```

#### 2.2 查询当前周签到配置 GET `/api/admin/checkin/current`

```javascript
// 响应体
{
  "success": true,
  "message": "查询成功",
  "data": {
    "week_range": {
      "monday": "2025-09-22",
      "sunday": "2025-09-28"
    },
    "cycles": [
      {
        "id": 1,
        "start_date": "2025-09-22",
        "end_date": "2025-09-28",
        "config": "[{\"day_of_week\":1,\"points\":11,\"is_surprise\":0,\"surprise_info\":null},...7天配置]",
        "created_at": "2025-09-25 06:40:28.683 +00:00",
        "updated_at": "2025-09-25 06:40:28.683 +00:00"
      }
      // ... 更多签到配置
    ],
    "count": 5
  }
}
```

#### 2.3 手动生成签到配置 POST `/api/admin/checkin/generate`

```javascript
// 查询参数 (可选)
?date=2025-10-06  // 指定周的任意日期

// 响应体
{
  "success": true,
  "message": "签到配置生成成功",
  "data": null
}
```

#### 2.4 查看商品券列表 GET `/api/admin/checkin/products`

```javascript
// 查询参数 (可选)
?status=2  // 商品券状态: 2=用于签到, 1=可兑换, 0=已下架

// 响应体
{
  "success": true,
  "message": "查询成功",
  "data": {
    "products": [
      {
        "id": 5,
        "name": "签到专享5元券",
        "description": "签到惊喜专享，满25元可用，有效期7天",
        "points": 40,
        "status": 2
      }
      // ... 更多商品券
    ],
    "count": 4
  }
}
```

#### 2.5 手动执行朴分过期 POST `/api/admin/point/expire` 🆕

```javascript
// 响应体（成功执行过期）
{
  "success": true,
  "message": "朴分过期操作完成：1个用户，共过期11朴分",
  "data": {
    "expiredUsers": 1,
    "totalExpiredPoints": 11,
    "expireDate": "2025-09-28",
    "details": [
      {
        "userId": 12,
        "username": "test_user",
        "expiredPoints": 11,
        "recordId": 24
      }
    ]
  }
}

// 响应体（没有用户需要过期）
{
  "success": true,
  "message": "没有用户需要执行朴分过期操作",
  "data": {
    "expiredUsers": 0,
    "totalExpiredPoints": 0
  }
}
```

#### 2.6 检查过期日期 GET `/api/admin/point/expire-check` 🆕

```javascript
// 响应体
{
  "success": true,
  "message": "获取朴分过期日期检查结果成功",
  "data": {
    "currentDate": "2025-09-28",
    "currentDateTime": "2025-09-28T07:07:38.255Z",
    "isExpireDate": false,
    "nextExpireDates": [
      "2025-09-30",
      "2025-12-31"
    ]
  }
}
```

### 3. 朴分相关接口 (/api/point/\*) - 🆕 新增

#### 3.1 用户签到 POST `/api/point/checkin`

```javascript
// 请求头
Authorization: Bearer <token>

// 响应体（基础签到）
{
  "code": 200,
  "message": "签到成功",
  "data": {
    "success": true,
    "basic_points": 15,
    "total_points_earned": 15,
    "surprise_rewards": [],
    "message": "签到成功！获得15朴分"
  }
}

// 响应体（含惊喜奖励 - 商品券）
{
  "code": 200,
  "message": "签到成功",
  "data": {
    "success": true,
    "basic_points": 20,
    "total_points_earned": 20,
    "surprise_rewards": [
      {
        "type": "coupon",
        "coupon_id": 7,
        "coupon_name": "签到专享15元券",
        "coupon_description": "签到惊喜专享，满80元可用，有效期7天"
      }
    ],
    "message": "签到成功！获得20朴分，惊喜获得签到专享15元券"
  }
}

// 响应体（含惊喜奖励 - 概率瓜分）
{
  "code": 200,
  "message": "签到成功",
  "data": {
    "success": true,
    "basic_points": 18,
    "total_points_earned": 68,  // 18 + 50瓜分奖励
    "surprise_rewards": [
      {
        "type": "lottery",
        "pool_name": "瓜分888朴分",
        "points": 50,
        "message": "恭喜获得50朴分"
      }
    ],
    "message": "签到成功！获得18朴分，恭喜获得50朴分"
  }
}

// 错误响应（重复签到）
{
  "code": 400,
  "message": "今日已签到，请勿重复签到",
  "data": null
}
```

#### 3.2 获取朴分记录 GET `/api/point/records`

```javascript
// 请求头
Authorization: Bearer <token>

// 查询参数（可选）
?page=1&limit=20&change_type=checkin&start_date=2025-09-01&end_date=2025-09-30

// 响应体
{
  "code": 200,
  "message": "获取朴分记录成功",
  "data": {
    "records": [
      {
        "id": 1,
        "user_id": 1,
        "change_type": "checkin",
        "related_info": "{\"type\":\"签到\",\"description\":\"第5天签到\",\"day_of_week\":5,\"points\":18}",
        "points": 18,
        "total_points": 68,
        "created_time": "2025-09-26T08:30:15.000Z",
        "created_at": "2025-09-26T08:30:15.000Z",
        "updated_at": "2025-09-26T08:30:15.000Z"
      },
      {
        "id": 2,
        "user_id": 1,
        "change_type": "checkin",
        "related_info": "{\"type\":\"朴分瓜分\",\"description\":\"签到惊喜 - 瓜分888朴分\",\"lottery_type\":\"checkin_surprise\",\"pool_name\":\"瓜分888朴分\",\"points\":50,\"message\":\"恭喜获得50朴分\"}",
        "points": 50,
        "total_points": 118,
        "created_time": "2025-09-26T08:30:15.000Z"
      }
    ],
    "total": 2,
    "page": 1,
    "limit": 20,
    "totalPages": 1
  }
}
```

### 4. 商品兑换接口 (/api/product/\*) - 🆕 新增

#### 4.1 获取可兑换商品券列表 GET `/api/product/exchangeable`

```javascript
// 请求头
Authorization: Bearer <
  token >
  // 响应体
  {
    code: 200,
    message: "获取可兑换商品券成功",
    data: {
      products: [
        {
          id: 1,
          name: "1元优惠券",
          description: "满10元可用，有效期30天",
          points: 1,
          image_url: null,
          status: 1,
          created_at: "2025-09-25T06:40:28.683Z",
          updated_at: "2025-09-25T06:40:28.683Z",
          exchangeable: true, // 用户朴分是否足够兑换
          user_points: 14, // 用户当前朴分
        },
        {
          id: 2,
          name: "5元优惠券",
          description: "满30元可用，有效期30天",
          points: 20,
          image_url: null,
          status: 1,
          created_at: "2025-09-25T06:40:28.683Z",
          updated_at: "2025-09-25T06:40:28.683Z",
          exchangeable: false, // 朴分不足
          user_points: 14,
        },
      ],
      user_total_points: 14,
      count: 4,
    },
  };
```

#### 4.2 兑换商品券 POST `/api/product/exchange`

```javascript
// 请求头
Authorization: Bearer <token>

// 请求体
{
  "product_id": 1  // 要兑换的商品ID
}

// 响应体（成功）
{
  "code": 200,
  "message": "兑换成功！",
  "data": {
    "success": true,
    "exchange": {
      "id": 1,
      "expire_at": "2025-09-30",
      "exchange_time": "2025-09-28T14:19:57.368Z"
    },
    "product": {
      "id": 1,
      "name": "1元优惠券",
      "description": "满10元可用，有效期30天",
      "points": 1
    },
    "point_change": {
      "old_points": 14,
      "new_points": 13,
      "cost_points": 1
    }
  }
}

// 错误响应（朴分不足）
{
  "code": 400,
  "message": "朴分余额不足",
  "data": null
}

// 错误响应（商品不存在）
{
  "code": 404,
  "message": "商品不存在",
  "data": null
}
```

#### 4.3 获取用户兑换记录 GET `/api/product/exchanges`

```javascript
// 请求头
Authorization: Bearer <token>

// 查询参数（可选）
?page=1&limit=20&status=exchanged

// 响应体
{
  "code": 200,
  "message": "获取兑换记录成功",
  "data": {
    "records": [
      {
        "id": 1,
        "user_id": 6,
        "product_id": 1,
        "exchange_time": "2025-09-28T14:19:57.368Z",
        "points": 1,
        "status": "exchanged",
        "expire_at": "2025-09-30",
        "created_at": "2025-09-28T14:19:57.368Z",
        "updated_at": "2025-09-28T14:19:57.368Z",
        "product": {
          "id": 1,
          "name": "1元优惠券",
          "description": "满10元可用，有效期30天",
          "image_url": null
        }
      }
    ],
    "total": 1,
    "page": 1,
    "limit": 20,
    "totalPages": 1
  }
}
```

### 5. 组队功能接口 (/api/team/\*) - 🆕 新增

#### 5.1 队长创建组队 POST `/api/team/create`

```javascript
// 请求头
Authorization: Bearer <token>

// 响应体
{
  "code": 201,
  "message": "组队创建成功",
  "data": {
    "id": 1,
    "team_code": "aB3Cd5Ef", // 8位混合字符码
    "captain_id": 1,
    "status": "pending",
    "created_time": "2025-09-29T02:32:36.944Z",
    "expire_time": "2025-09-29T06:32:36.944Z", // 4小时过期
    "captain_username": "captain123"
  }
}

// 错误响应（今日已创建）
{
  "code": 400,
  "message": "今日已创建组队，无法重复创建",
  "data": null
}
```

#### 5.2 队员加入组队 POST `/api/team/join`

```javascript
// 请求头
Authorization: Bearer <token>

// 请求体
{
  "team_code": "aB3Cd5Ef"  // 8位混合字符团队码
}

// 响应体（普通加入）
{
  "code": 200,
  "message": "加入组队成功",
  "data": {
    "team": {
      "id": 1,
      "team_code": "aB3Cd5Ef",
      "status": "pending",
      "member_count": 3,
      "completed_time": null
    },
    "user": {
      "id": 2,
      "username": "member123",
      "role": "member",
      "join_time": "2025-09-29T02:35:15.123Z"
    }
  }
}

// 响应体（团队满员，触发奖励）🎉
{
  "code": 200,
  "message": "组队成功完成！获得朴分奖励",
  "data": {
    "team": {
      "id": 1,
      "team_code": "aB3Cd5Ef",
      "status": "completed",
      "member_count": 4,
      "completed_time": "2025-09-29T02:39:08.656Z"
    },
    "user": {
      "id": 4,
      "username": "member456",
      "role": "member",
      "join_time": "2025-09-29T02:39:08.656Z"
    },
    "rewards": {
      "captain": {
        "user_id": 1,
        "username": "captain123",
        "points": 70,
        "record_id": 15
      },
      "members": [
        {
          "user_id": 2,
          "username": "member123",
          "points": 10,
          "record_id": 16
        },
        {
          "user_id": 3,
          "username": "member234",
          "points": 10,
          "record_id": 17
        },
        {
          "user_id": 4,
          "username": "member456",
          "points": 10,
          "record_id": 18
        }
      ],
      "total_distributed": 100
    }
  }
}

// 错误响应（团队码无效）
{
  "code": 400,
  "message": "组队码无效",
  "data": null
}
```

#### 5.3 获取组队详情 GET `/api/team/:team_code`

```javascript
// 响应体
{
  "code": 200,
  "message": "获取组队详情成功",
  "data": {
    "id": 1,
    "team_code": "aB3Cd5Ef",
    "captain": {
      "id": 1,
      "username": "captain123"
    },
    "status": "completed",
    "created_time": "2025-09-29T02:32:36.552Z",
    "expire_time": "2025-09-29T06:32:36.552Z",
    "completed_time": "2025-09-29T02:39:08.656Z",
    "member_count": 4,
    "members": [
      {
        "id": 1,
        "username": "captain123",
        "role": "captain",
        "join_time": "2025-09-29T02:32:36.552Z"
      },
      {
        "id": 2,
        "username": "member123",
        "role": "member",
        "join_time": "2025-09-29T02:35:15.123Z"
      },
      {
        "id": 3,
        "username": "member234",
        "role": "member",
        "join_time": "2025-09-29T02:37:20.456Z"
      },
      {
        "id": 4,
        "username": "member456",
        "role": "member",
        "join_time": "2025-09-29T02:39:08.656Z"
      }
    ]
  }
}
```

#### 5.4 检查创建状态 GET `/api/team/check-created-today`

```javascript
// 请求头
Authorization: Bearer <token>

// 响应体（未创建）
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "userId": 1,
    "hasCreatedTeamToday": false,
    "teamCode": null,
    "team": null,
    "message": "今日未创建组队"
  }
}

// 响应体（已创建）
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "userId": 1,
    "hasCreatedTeamToday": true,
    "teamCode": "6igEkGok",
    "team": {
      "id": 2,
      "team_code": "6igEkGok",
      "captain_id": 4,
      "status": "pending",
      "created_time": "2025-09-29T09:22:27.783Z",
      "expire_time": "2025-09-29T13:22:27.783Z",
      "completed_time": null
    },
    "message": "今日已创建组队"
  }
}
```

#### 5.5 检查加入状态 GET `/api/team/check-joined-today`

```javascript
// 请求头
Authorization: Bearer <token>

// 响应体（未加入）
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "userId": 5,
    "hasJoinedTeamToday": false,
    "teamCode": null,
    "team": null,
    "message": "今日未参与组队"
  }
}

// 响应体（已加入）
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "userId": 5,
    "hasJoinedTeamToday": true,
    "teamCode": "6igEkGok",
    "team": {
      "id": 2,
      "team_code": "6igEkGok",
      "captain_id": 4,
      "status": "pending",
      "created_time": "2025-09-29T09:22:27.783Z",
      "expire_time": "2025-09-29T13:22:27.783Z",
      "completed_time": null
    },
    "message": "今日已参与组队"
  }
}
```

#### 5.6 获取用户组队记录 GET `/api/team/records` 🆕

```javascript
// 请求头
Authorization: Bearer <token>

// 查询参数（可选）
?page=1&limit=20&status=completed&role=captain&start_date=2025-09-01&end_date=2025-09-30

// 响应体
{
  "code": 200,
  "message": "获取组队记录成功",
  "data": {
    "records": [
      {
        "id": 8,
        "team_code": "nU22zIgu",
        "status": "completed",
        "user_role": "captain",  // 用户在该组队中的角色
        "created_time": "2025-09-29T16:33:43.483Z",
        "expire_time": "2025-09-29T20:33:43.483Z",
        "completed_time": "2025-09-29T16:33:43.584Z",
        "join_time": null,  // 队长为null，队员为加入时间
        "captain": {
          "id": 19,
          "username": "captain190"
        },
        "member_count": 4,
        "members": [
          {
            "id": 17,
            "team_id": 8,
            "user_id": 19,
            "role": "captain",
            "join_time": "2025-09-29T16:33:43.483Z",
            "user": {
              "id": 19,
              "username": "captain190"
            }
          },
          {
            "id": 18,
            "team_id": 8,
            "user_id": 20,
            "role": "member",
            "join_time": "2025-09-29T16:33:43.527Z",
            "user": {
              "id": 20,
              "username": "member1190"
            }
          }
          // ... 更多成员
        ]
      }
      // ... 更多组队记录
    ],
    "total": 1,
    "page": 1,
    "limit": 20,
    "totalPages": 1
  }
}
```

**查询参数说明：**

- `page`: 页码（默认 1）
- `limit`: 每页数量（默认 20，最大 100）
- `status`: 状态筛选（pending, completed, expired）
- `role`: 角色筛选（captain, member）
- `start_date`: 开始日期（YYYY-MM-DD）
- `end_date`: 结束日期（YYYY-MM-DD）

### 6. 系统接口

| 接口路径      | 方法 | 功能描述 | 状态      |
| ------------- | ---- | -------- | --------- |
| `/api/health` | GET  | 健康检查 | ✅ 已完成 |

#### 5.1 健康检查 GET `/api/health`

```javascript
// 响应体
{
  "code": 200,
  "message": "PuScore API服务运行正常",
  "data": {
    "timestamp": "2025-09-25T06:48:00.031Z",
    "version": "1.0.0",
    "timeControlEnabled": true,
    "environment": "development"
  }
}
```

## 🗄️ 数据库设计

### 已实现的数据表

#### 1. 用户表 (users)

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    username TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL,
    total_points INTEGER NOT NULL DEFAULT 0,
    status TINYINT NOT NULL DEFAULT 1,  -- 1:正常, 0:注销
    last_login_time DATETIME DEFAULT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. 商品券表 (products)

```sql
CREATE TABLE products (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    description TEXT DEFAULT NULL,
    points INTEGER NOT NULL CHECK (points > 0),
    image_url TEXT DEFAULT NULL,
    status TINYINT NOT NULL DEFAULT 1,  -- 2:用于签到, 1:可兑换, 0:已下架
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### 3. 签到周期表 (checkin_cycles)

```sql
CREATE TABLE checkin_cycles (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    start_date DATE NOT NULL,      -- 周一日期
    end_date DATE NOT NULL,        -- 周日日期
    config JSON NOT NULL,          -- 7天签到配置的JSON数据
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CHECK (start_date < end_date)
);
```

#### 4. 用户-签到关联表 (user_checkin_configs)

```sql
CREATE TABLE user_checkin_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    user_id INTEGER NOT NULL,           -- 关联用户表，级联删除
    cycle_id INTEGER NOT NULL,          -- 关联签到周期表，级联删除
    end_time DATE NOT NULL,             -- 签到周期结束时间(YYYY-MM-DD)
    day1 TINYINT NOT NULL DEFAULT 0,    -- 周一签到状态(0=未签到,1=已签到)
    day2 TINYINT NOT NULL DEFAULT 0,    -- 周二签到状态
    day3 TINYINT NOT NULL DEFAULT 0,    -- 周三签到状态
    day4 TINYINT NOT NULL DEFAULT 0,    -- 周四签到状态
    day5 TINYINT NOT NULL DEFAULT 0,    -- 周五签到状态
    day6 TINYINT NOT NULL DEFAULT 0,    -- 周六签到状态
    day7 TINYINT NOT NULL DEFAULT 0,    -- 周日签到状态
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, cycle_id),          -- 用户每个周期只能有一个配置
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
    FOREIGN KEY (cycle_id) REFERENCES checkin_cycles (id) ON DELETE CASCADE
);
```

#### 6. 兑换记录表 (products_exchanges) - 🆕 新增

```sql
CREATE TABLE products_exchanges (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    user_id INTEGER NOT NULL,                    -- 关联用户表，级联删除
    product_id INTEGER NOT NULL,                 -- 关联商品表，限制删除
    exchange_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 兑换时间
    points INTEGER NOT NULL CHECK (points > 0), -- 兑换消耗的朴分
    status TEXT NOT NULL DEFAULT 'exchanged',   -- 兑换状态(exchanged, used, expired)
    expire_at DATE DEFAULT NULL,                -- 商品券过期时间
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products (id) ON DELETE RESTRICT
);
```

#### 7. 团队表 (teams) - 🆕 新增

```sql
CREATE TABLE teams (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    team_code TEXT NOT NULL UNIQUE,             -- 8位混合字符团队码
    captain_id INTEGER NOT NULL,                -- 关联队长用户，级联删除
    status TEXT NOT NULL DEFAULT 'pending',     -- 团队状态: pending, completed, expired
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 创建时间
    expire_time DATETIME NOT NULL,              -- 过期时间
    completed_time DATETIME DEFAULT NULL,       -- 完成时间
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (captain_id) REFERENCES users (id) ON DELETE CASCADE
);
```

#### 8. 团队成员表 (team_members) - 🆕 新增

```sql
CREATE TABLE team_members (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    team_id INTEGER NOT NULL,                   -- 关联团队表，级联删除
    user_id INTEGER NOT NULL,                   -- 关联用户表，级联删除
    role TEXT NOT NULL DEFAULT 'member',        -- 角色: captain, member
    join_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 加入时间
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(team_id, user_id),                   -- 用户在同一团队只能有一个记录
    FOREIGN KEY (team_id) REFERENCES teams (id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);
```

#### 5. 朴分记录表 (point_records)

```sql
CREATE TABLE point_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    user_id INTEGER NOT NULL,                    -- 关联用户表，级联删除
    change_type TEXT NOT NULL,                   -- 变动类型: checkin, team, exchange, expire
    related_info TEXT DEFAULT NULL,              -- 关联业务信息JSON
    points INTEGER NOT NULL,                     -- 变动朴分（正数增加，负数减少）
    total_points INTEGER NOT NULL CHECK (total_points >= 0), -- 变动后总朴分
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 变动时间
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);
```

### 签到配置 JSON 数据格式

```json
[
  {
    "day_of_week": 1, // 星期几 (1-7)
    "points": 11, // 签到获得朴分
    "is_surprise": 0, // 是否有惊喜 (0:否, 1:是)
    "surprise_info": null // 惊喜详情 (商品券或瓜分奖励)
  },
  {
    "day_of_week": 2,
    "points": 15,
    "is_surprise": 1,
    "surprise_info": {
      "type": "coupon", // 惊喜类型: coupon=商品券, lottery=瓜分奖励
      "coupon_id": 6,
      "coupon_name": "签到专享8元券",
      "coupon_description": "签到惊喜专享，满40元可用，有效期7天"
    }
  },
  {
    "day_of_week": 3,
    "points": 20,
    "is_surprise": 1,
    "surprise_info": {
      "type": "lottery",
      "pool_name": "瓜分888朴分",
      "total_points": 888,
      "probabilities": [
        // 概率配置
        { "prob": 0.2, "points": 0, "message": "很遗憾，未中奖" },
        { "prob": 0.4, "points": 30, "message": "恭喜获得30朴分" },
        { "prob": 0.01, "points": 888, "message": "恭喜获得大奖888朴分！" }
      ]
    }
  }
  // ... day 4-7
]
```

## 🔧 系统配置

### 签到配置文件 (config/checkin.js)

```javascript
{
  cycleCount: 5,                    // 每周生成5个签到配置
  points: { min: 5, max: 25 },      // 朴分范围
  surpriseConfig: {
    surpriseDaysRange: { min: 1, max: 3 },  // 惊喜天数1-3天
    rewardTypes: {
      coupon: { weight: 0.6 },      // 商品券惊喜概率60%
      lottery: { weight: 0.4 }      // 瓜分奖励惊喜概率40%
    }
  },
  generateTime: { hour: 0, minute: 0 }  // 每周一00:00自动生成
}
```

### 定时任务

- **签到配置生成**: 每周一 00:00 自动生成新一周的 5 个签到配置
- **时间控制**: 支持开发环境时间调控，方便测试

## 📊 测试数据

### 商品券初始数据

系统自动初始化 9 条商品券记录：

- **可兑换商品券** (status=1): 5 元券、10 元券、20 元券、免邮券
- **签到专用商品券** (status=2): 签到专享 5 元券、8 元券、15 元券、免邮券
- **已下架商品券** (status=0): 过期优惠券

### 签到周期示例

- 当前周 (2025-09-22 ~ 2025-09-28): 已生成 5 个配置
- 下一周 (2025-09-29 ~ 2025-10-05): 已生成 5 个配置
- 下下周 (2025-10-06 ~ 2025-10-12): 可通过 API 生成

## 🧪 测试说明

### 测试脚本

提供了完整的 API 测试脚本:

- `api_test/test_checkin_system.sh` - 签到配置系统测试
- `api_test/test_user_checkin.sh` - 用户签到信息 API 测试
- `api_test/test_checkin_function.sh` - 用户签到执行功能完整测试
- `api_test/test_point_expire.sh` - 朴分过期功能完整测试 🆕
- `api_test/test_product_exchange.sh` - 商品兑换功能完整测试 🆕
- `api_test/test_team_function_v2.sh` - 组队功能完整测试 🆕
- `api_test/test_team_rewards_complete.sh` - 团队奖励功能完整测试 🎉
- `api_test/test_user_team_records.sh` - 用户组队记录功能完整测试 🆕

运行测试:

```bash
cd /Users/pupu/Desktop/PuScore/server

# 测试签到配置系统
chmod +x ./api_test/test_checkin_system.sh
./api_test/test_checkin_system.sh

# 测试用户签到信息API
chmod +x ./api_test/test_user_checkin.sh
./api_test/test_user_checkin.sh

# 测试用户签到执行功能（完整流程）
chmod +x ./api_test/test_checkin_function.sh
./api_test/test_checkin_function.sh

# 测试朴分过期功能（完整流程）🆕
chmod +x ./api_test/test_point_expire.sh
./api_test/test_point_expire.sh

# 测试商品兑换功能（完整流程）🆕
chmod +x ./api_test/test_product_exchange.sh
./api_test/test_product_exchange.sh

# 测试组队功能（完整流程）🆕
chmod +x ./api_test/test_team_function_v2.sh
./api_test/test_team_function_v2.sh

# 测试团队奖励功能（完整流程）🎉
chmod +x ./api_test/test_team_rewards_complete.sh
./api_test/test_team_rewards_complete.sh

# 测试用户组队记录功能（完整流程）🆕
chmod +x ./api_test/test_user_team_records.sh
./api_test/test_user_team_records.sh
```

### 测试结果示例

**签到配置系统测试:**

```
📦 测试1: 查看用于签到的商品券列表
✅ 成功获取 4 个签到商品券

📅 测试2: 查看当前周签到配置
✅ 当前周期: 2025-09-22 到 2025-09-28
✅ 共有 5 个签到配置

🔧 测试4: 生成新的签到周期
✅ 新签到周期生成成功
```

**用户签到信息 API 测试:**

```
📝 步骤1: 注册测试用户
✅ 注册成功，Token: eyJhbGciOiJIUzI1NiIs...

📅 步骤2: 获取用户签到信息
✅ 成功获取签到信息，包含7天配置和签到状态
✅ 正确标记今天是周四 (is_today: true)
✅ 自动分配签到配置 (cycle_id: 3)
```

**用户签到执行功能测试:** 🆕

```
🎯 PuScore 用户签到功能API测试
📝 步骤1: 注册测试用户
✅ 注册成功，Token: eyJhbGciOiJIUzI1NiIs...

📅 步骤2: 获取用户签到信息（自动分配签到配置）
✅ 成功获取签到信息，今天是周5，包含惊喜奖励配置

✅ 步骤3: 执行签到操作
✅ 签到成功，获得24朴分
✅ 消息生成正确："签到成功！获得24朴分"

📊 步骤4: 查看朴分记录
✅ 成功创建朴分记录，共1条记录
✅ 记录包含完整信息（用户ID、变动类型、朴分数、关联信息等）

🔄 步骤5: 测试重复签到（应该失败）
✅ 重复签到被正确阻止："今日已签到，请勿重复签到"

📈 步骤6: 查看用户个人信息（验证朴分更新）
✅ 用户朴分正确更新

🧪 步骤7: 测试朴分记录筛选功能
✅ 按签到类型筛选记录正常，返回正确的记录数量
```

**商品兑换功能测试:** 🆕

```
🛍️ PuScore 商品兑换功能API测试
📝 步骤1: 注册测试用户
✅ 注册成功，Token: eyJhbGciOiJIUzI1NiIs...

🎯 步骤2: 获取签到信息并签到获得朴分
✅ 成功获取签到信息并分配签到配置
✅ 签到成功，获得14朴分

👤 步骤3: 查看用户当前朴分
✅ 用户当前朴分: 14

🛍️ 步骤4: 获取可兑换商品券列表
✅ 成功获取可兑换商品券列表
📦 可兑换商品券数量: 4
📋 商品券列表:
ID: 1, 名称: 1元优惠券, 需要朴分: 1, 可兑换: true
ID: 3, 名称: 10元优惠券, 需要朴分: 10, 可兑换: true
ID: 2, 名称: 5元优惠券, 需要朴分: 20, 可兑换: false
ID: 4, 名称: 免邮券, 需要朴分: 30, 可兑换: false

💳 步骤5: 兑换商品券
✅ 兑换成功！
⏰ 过期时间: 2025-09-30
💰 朴分变化: 14 → 13 (消耗 1 朴分)

📜 步骤6: 获取用户兑换记录
✅ 成功获取兑换记录
📝 兑换记录总数: 1
📋 兑换记录详情:
商品: 1元优惠券, 消耗朴分: 1, 状态: exchanged

🎉 商品兑换功能API测试完成！
```

**团队奖励功能测试:** 🎉

```
🎯 PuScore 团队奖励功能 API 测试
📝 步骤1: 注册测试用户
✅ 注册成功，Token: eyJhbGciOiJIUzI1NiIs...

📅 步骤4: 队长创建组队
✅ 团队创建成功，团队码: aB3Cd5Ef

📋 步骤5: 验证团队码格式（混合字符）
✅ 长度正确: 8位
✅ 包含数字
✅ 包含大写字母
✅ 包含小写字母

👥 步骤6: 队员依次加入组队
✅ 队员1加入成功
✅ 队员2加入成功
✅ 队员3加入成功（团队满员，触发奖励）

🎁 步骤7: 检查奖励分发
✅ 响应包含奖励信息
✅ 奖励分发详情:
   - 队长获得70朴分
   - 队员1获得10朴分
   - 队员2获得10朴分
   - 队员3获得10朴分

💰 步骤8: 验证积分变化
✅ 队长积分奖励正确（+70）
✅ 队员1积分奖励正确（+10）
✅ 队员2积分奖励正确（+10）
✅ 队员3积分奖励正确（+10）

📊 团队详情:
✅ 团队状态: completed
✅ 团队成员: 4人
✅ 完成时间: 2025-09-29T02:39:08.656Z

🎉 团队奖励功能API测试完成！
```

**用户组队记录功能测试:** 🆕

```
🎯 PuScore 用户组队记录功能API测试
📝 步骤1: 注册测试用户
✅ 队长注册成功，Token: eyJhbGciOiJIUzI1NiIs...

📅 步骤3: 队长创建组队
✅ 队长创建组队成功，组队码: nU22zIgu

👥 步骤4: 队员依次加入组队
✅ 队员1加入成功
✅ 队员2加入成功
✅ 队员3加入成功（触发团队完成）

📊 步骤5: 测试队长的组队记录
✅ 队长组队记录查询成功
📝 队长组队记录总数: 1
✅ 队长记录信息正确 - 角色: captain, 状态: completed, 组队码: nU22zIgu

📊 步骤6: 测试队员的组队记录
✅ 队员组队记录查询成功
📝 队员组队记录总数: 1
✅ 队员记录信息正确 - 角色: member, 状态: completed, 组队码: nU22zIgu

🔍 步骤7: 测试按角色筛选 - 只查看队长记录
✅ 队长角色筛选成功，共 1 条队长记录

🔍 步骤8: 测试按角色筛选 - 只查看队员记录
✅ 队员角色筛选成功，共 1 条队员记录

🔍 步骤9: 测试按状态筛选 - 只查看已完成的组队
✅ 状态筛选成功，共 1 条已完成记录

📄 步骤10: 测试分页功能
✅ 分页功能测试成功
📊 分页信息：第 1 页，每页 1 条，总计 1 条记录

🔍 步骤11: 测试组合筛选（角色+状态）
✅ 组合筛选测试成功，共 1 条记录（队长且已完成）

📅 步骤12: 测试时间筛选
✅ 时间筛选测试成功，今日共 0 条记录

🎉 用户组队记录API测试完成！
```

## 🚀 部署信息

### 环境要求

- Node.js >= 16.x
- SQLite 3
- npm >= 8.x

### 启动服务

```bash
cd server
npm install
npm start
```

### 环境变量

```bash
PORT=3000                    # 服务端口
HOST=0.0.0.0                # 服务地址
NODE_ENV=development         # 环境模式
JWT_SECRET=your_jwt_secret   # JWT密钥
```

## 📝 开发进度

### 当前进度: 100%

- ✅ 基础架构搭建 (100%)
- ✅ 用户认证系统 (100%)
- ✅ 时间控制系统 (100%)
- ✅ 签到配置生成 (100%)
- ✅ 用户签到信息系统 (100%)
- ✅ 用户签到执行功能 (100%)
- ✅ 朴分过期管理功能 (100%)
- ✅ 商品兑换功能 (100%)
- ✅ 组队功能 (100%)
- ✅ 团队奖励分发功能 (100%) 🎉

### 下一步计划

1. ✅ ~~实现用户签到执行功能 - 实际签到操作、朴分增加、惊喜奖励处理~~ **已完成**
2. ✅ ~~实现朴分过期管理功能 - 定时过期、手动过期、过期记录~~ **已完成**
3. ✅ ~~完成朴分兑换和记录系统 - 商品券兑换、兑换记录管理~~ **已完成**
4. ✅ ~~开发组队创建和加入功能~~ **已完成**
5. ✅ ~~开发组队朴分瓜分功能~~ **已完成** 🎉
6. 前端界面开发

### 📝 最新完成功能 (2025-09-30)

**用户组队记录查询功能** 🆕：

- ✅ 用户组队记录 API - `GET /api/team/records` 获取用户历史组队记录
- ✅ 多维度筛选支持 - 支持按角色（队长/队员）、状态（pending/completed/expired）筛选
- ✅ 时间范围筛选 - 支持按创建日期范围查询组队记录
- ✅ 分页查询功能 - 支持分页参数，默认每页 20 条，最大 100 条
- ✅ 组合筛选功能 - 支持多条件组合筛选，如角色+状态+时间范围
- ✅ 完整数据返回 - 包含组队详情、成员信息、用户角色等完整数据
- ✅ 路由优化处理 - 解决路由冲突问题，确保 API 正确访问
- ✅ 完整测试验证 - 提供 12 个测试步骤的完整功能测试脚本

**团队奖励分发功能**：

- ✅ 混合字符团队码生成 - 8 位混合字符（数字+大小写字母）
- ✅ 团队满员自动检测 - 当团队达到 4 人时自动触发奖励
- ✅ 朴分奖励分发规则 - 队长获得 70 朴分，队员各获得 10 朴分
- ✅ 奖励记录完整管理 - 使用 pointUtil 创建详细的朴分变动记录
- ✅ API 响应增强 - 加入完整的奖励分发信息到 API 响应中
- ✅ 路由验证更新 - 支持混合字符团队码的正则表达式验证
- ✅ 事务安全保障 - 确保奖励分发的原子性和数据一致性
- ✅ 完整测试验证 - 提供完整的团队奖励功能测试脚本

**组队功能**：

- ✅ 组队数据模型创建 (Team & TeamMember)
- ✅ 完整的组队服务实现 (teamService)
- ✅ 队长创建组队 API - 8 位唯一组队码生成
- ✅ 队员加入组队 API - 组队码验证和自动完成
- ✅ 组队状态检查 API - 每日创建/参与限制检查
- ✅ 组队过期管理 - 4 小时或当天结束时间计算
- ✅ 组队详情查询 API - 完整成员信息展示
- ✅ 用户组队记录查询 API - 支持多维度筛选和分页查询
- ✅ 使用本机时间进行状态管理
- ✅ 数据库事务安全保障
- ✅ 完整的 API 测试脚本和验证

**技术亮点**：

- 混合字符团队码：8 位混合字符码（数字+大小写字母）生成算法，保证包含每种字符类型
- 自动奖励分发机制：团队达到 4 人时自动触发，队长 70 朴分，队员各 10 朴分
- 完整的奖励记录：所有奖励变动使用 createPointRecord 统一管理
- 事务安全保障：确保团队创建、加入、奖励分发的原子性操作
- API 响应增强：返回完整的奖励分发详情，便于前端展示
- 路由验证升级：支持混合字符团队码的正则表达式验证 `^[a-zA-Z0-9]{8}$`
- 时间服务集成：统一使用 timeService.now() 获取时间，支持开发环境时间控制

---

**最后更新**: 2025-09-30  
**项目状态**: 开发中 - 用户组队记录功能已完成 �  
**完成度**: 100% (核心功能)  
**联系方式**: 开发团队
